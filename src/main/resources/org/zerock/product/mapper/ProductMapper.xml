<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.zerock.product.mapper.ProductMapper">

	<select id="readOrderbyOrderSeq"
		resultType="org.zerock.product.domain.OrderVO">
		select * from tbl_order where order_seq = #{order_seq} order_status = 0;
	</select>

	<update id="updateProductLike">
		UPDATE tbl_product SET product_like = #{product_like} WHERE product_seq = #{product_seq}
	</update>

	<insert id="insertProductLike">
		insert into tbl_productlike (product_seq, user_seq) 
		VALUES
		(#{product_seq}, #{user_seq})
	</insert>
	
	<select id="countUserSeqByProductSeq" resultType="int">
		SELECT count(user_seq) FROM tbl_productlike WHERE product_seq = #{product_seq}
	</select>
	
	<select id="checkProductLike" resultType="int">
		SELECT count(*) FROM tbl_productlike WHERE product_seq = #{product_seq} AND user_seq = #{user_seq}
	</select>
	
	<delete id="deleteProductLike">
		delete from tbl_productlike where product_seq = #{product_seq} AND user_seq = #{user_seq}
	</delete>
	

	<insert id="insertOrder">
		insert into tbl_order (order_seq, order_productseq, order_poseq,
		order_poname, order_poprice, order_quantity, order_userseq, order_username, order_useraddress, order_userphone, order_filename)
		values 
		(order_seq.nextval, #{order_productseq}, #{order_poseq},
		#{order_poname}, #{order_poprice}, #{order_quantity},
		#{order_userseq}, #{order_username}, #{order_useraddress}, #{order_userphone}, #{order_filename})
	</insert>

	<insert id="insertProductOption" >
		insert into tbl_productoption (productoption_seq, product_seq, po_name, po_quantity, po_price
		) values 
		 (productoption_seq.nextval
		 ,#{product_seq}
		 ,#{po_name}
		 ,#{po_quantity}
		 ,#{po_price})
	</insert>
	
	<insert id="insert">
		insert into tbl_product (product_seq, product_name, product_price,
		product_quantity, product_seller, product_filename, product_info, category_seq, user_nickname)
		values (product_seq.nextval, #{product_name}, #{product_price},
		#{product_quantity}, #{product_seller}, #{product_filename},
		#{product_info}, #{category_seq}, #{user_nickname})
	</insert>
	
	<select id="getProductOptionList" resultType="org.zerock.product.domain.ProductOptionVO">
		SELECT productoption_seq, product_seq, po_name, po_quantity, po_price FROM tbl_productoption 
		WHERE product_seq = #{product_seq}
	</select>
	
	<insert id="insertReturnSeq" keyProperty="product_seq">
		<selectKey keyProperty="product_seq" order="BEFORE" resultType="Integer">
  			select product_seq.nextval from DUAL
  		</selectKey> 
		insert into tbl_product (product_seq, product_name, product_price,
		product_quantity, product_seller, product_filename, product_info, category_seq, user_nickname)
		values (#{product_seq}, #{product_name}, #{product_price},
		#{product_quantity}, #{product_seller}, #{product_filename},
		#{product_info}, #{category_seq}, #{user_nickname})
	</insert>

	<sql id="criteria">
		<where>
			<foreach item="type" collection="typeArr" separator="OR">
				<choose>
					<when test="type == 'T'.toString()">
						product_name LIKE '%' || #{keyword} || '%'
					</when>
					<when test="type == 'C'.toString()">
						product_info LIKE '%' || #{keyword} || '%'
					</when>
					<when test="type == 'W'.toString()">
						user_nickname LIKE '%' || #{keyword} || '%'
					</when>
				</choose>
			</foreach>
		</where>
	</sql>

	<!-- <select id="getList" resultType="org.zerock.domain.BoardVO"> <![CDATA[ 
		select * from tbl_board where bno > 0 ]]> </select> -->

	<select id="getListWithPaging"
		resultType="org.zerock.product.domain.ProductVO">
<![CDATA[   
   SELECT
    product_seq, product_name, product_price, product_quantity, product_seller, product_filename, 
    product_info, category_seq, product_readcnt, product_status, product_regdate, product_updatedate, 
    user_nickname, product_like 
   FROM
    (
     SELECT 
      ROW_NUMBER() OVER ( ORDER BY 
 ]]>  
			<choose>
				<when test="array == 'latest'">
					product_seq DESC
				</when>
				<when test="array == 'like'">
					product_like DESC
				</when>
				<when test="array == 'priceHign'">
					product_price DESC
				</when>
				<when test="array == 'priceLow'">
					product_price
				</when>
				<when test="array == 'readcnt'">
					product_readcnt DESC
				</when>
				<otherwise>
					product_seq DESC
				</otherwise>
			</choose>
 <![CDATA[
      ) rn, product_seq, product_name, product_price, product_quantity, product_seller, 
      product_filename, product_info, category_seq, product_readcnt, product_status, product_regdate, 
      product_updatedate, user_nickname, product_like
   FROM
      tbl_product
]]>

		<include refid="criteria"></include>
   
<![CDATA[
    )
   WHERE
    rn BETWEEN (#{pageNum} - 1) * #{amount} + 1 AND #{pageNum} * #{amount}
]]>
	</select>


	<!-- <insert id="insertSelectKey"> <selectKey keyProperty="bno" order="BEFORE" 
		resultType="long"> select seq_board.nextval from dual </selectKey> insert 
		into tbl_board (bno, title, content, writer) values (#{bno }, #{title}, #{content}, 
		#{writer}) </insert> -->

	<select id="read"
		resultType="org.zerock.product.domain.ProductVO">
		select * from tbl_product where product_seq = #{product_seq}
	</select>

	<update id="readCountUp">
		UPDATE tbl_product
			SET
			product_readcnt = product_readcnt + 1
			WHERE
			product_seq = #{product_seq}
	</update>

	<delete id="delete">
		delete from tbl_product where product_seq = #{product_seq}
	</delete>

	<update id="update">
		UPDATE tbl_product
		SET
		product_name = #{product_name},
		product_filename = #{product_filename},
		product_info = #{product_info},
		category_seq = #{category_seq},
		user_nickname = #{user_nickname},
		product_updateDate = sysdate
		WHERE
		product_seq = #{product_seq}
	</update>

	<update id="stopSelling">
		UPDATE tbl_product
		SET
		product_status = 1,
		product_updateDate = sysdate
		WHERE
		product_seq = #{product_seq}
	</update>

	<select id="getTotalCount" resultType="int">
		SELECT count(*) FROM tbl_product
		<include refid="criteria"></include>
	</select>

</mapper>